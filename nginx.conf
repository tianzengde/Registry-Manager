server {
  listen 80;
  listen [::]:80;

  # 要添加证书，就用下面注释的配置
  #listen 443 ssl;
  #listen [::]:443 ssl;
  #server_name your-domain.com;
  #ssl_certificate /etc/nginx/ssl/cert.pem;
  #ssl_certificate_key /etc/nginx/ssl/key.pem;
  #ssl_protocols TLSv1.2 TLSv1.3;

  # 设置客户端最大请求体大小，用于大镜像上传
  client_max_body_size 4G;

  # Docker Registry Token Authentication
  location /token {
    proxy_pass http://registry-manager:8000/token;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
  
  # Registry Manager 管理界面
  location / {
    proxy_pass http://registry-manager:8000;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # 支持 WebSocket 连接
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 超时设置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Docker Registry API 接口 - 通过 registry-manager 代理（含权限检查）
  location /v2/ {
    proxy_pass http://registry-manager:8000/v2/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # 支持大文件上传
    client_max_body_size 4G;
    proxy_request_buffering off;
    
    # 超时设置
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
  }

  # 健康检查端点
  location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
  }
}

