{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - Docker Registry Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ä»ªè¡¨æ¿</h1>
</div>

<div class="dashboard-grid">
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“¦ ä»“åº“ç»Ÿè®¡</h3>
        </div>
        <div class="card-body">
            <div class="stat-number" id="repo-count">-</div>
            <p>å¯è®¿é—®çš„ä»“åº“æ•°é‡</p>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3>ğŸ·ï¸ é•œåƒç»Ÿè®¡</h3>
        </div>
        <div class="card-body">
            <div class="stat-number" id="image-count">-</div>
            <p>æ€»é•œåƒæ ‡ç­¾æ•°</p>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3>ğŸ” æƒé™ä¿¡æ¯</h3>
        </div>
        <div class="card-body">
            <p><strong>ç”¨æˆ·ç±»å‹:</strong> <span id="user-type">-</span></p>
            <p><strong>å¯æ¨é€ä»“åº“:</strong> <span id="push-repos">-</span></p>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3>ğŸ”— Registry çŠ¶æ€</h3>
        </div>
        <div class="card-body">
            <div class="status-indicator" id="registry-status">
                <span class="status-dot"></span>
                <span>æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3>æ‰€æœ‰ä»“åº“</h3>
    </div>
    <div class="card-body">
        <div id="recent-repos" class="repo-list" style="max-height: 600px; overflow-y: auto;">
            <p class="loading">åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    await loadDashboard();
});

async function loadDashboard() {
    try {
        // Load user info and repositories in parallel
        const [userInfo, repos] = await Promise.all([
            apiRequest('/api/users/me'),
            apiRequest('/api/repositories/')
        ]);
        
        document.getElementById('user-type').textContent = userInfo.is_admin ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
        document.getElementById('repo-count').textContent = repos.length;
        
        const repoList = document.getElementById('recent-repos');
        repoList.innerHTML = '';
        
        if (repos.length === 0) {
            repoList.innerHTML = '<p>æš‚æ— å¯è®¿é—®çš„ä»“åº“</p>';
            document.getElementById('image-count').textContent = '0';
        } else {
            // Show loading for all repos
            repoList.innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½ä»“åº“æ ‡ç­¾ä¿¡æ¯...</p>';
            
            // Load ALL repository tags in parallel (not just first 5)
            const tagPromises = repos.map(repo => 
                apiRequest(`/api/images/${encodeURIComponent(repo.name).replace(/%2F/g, '/')}/tags`)
                    .then(tags => ({ repo, tags: tags.tags }))
                    .catch(error => {
                        console.error(`Failed to load tags for ${repo.name}:`, error);
                        return { repo, tags: [] };
                    })
            );
            
            // Wait for all tag requests to complete
            const allRepoTags = await Promise.all(tagPromises);
            
            // Calculate total images from ALL repos
            const totalImages = allRepoTags.reduce((sum, item) => sum + item.tags.length, 0);
            document.getElementById('image-count').textContent = totalImages;
            
            // Display all repos (not just first 5)
            repoList.innerHTML = '';
            for (const { repo, tags } of allRepoTags) {
                const repoItem = document.createElement('div');
                repoItem.className = 'repo-item';
                repoItem.innerHTML = `
                    <div>
                        <strong>${repo.name}</strong>
                        ${repo.is_public ? '<span class="badge badge-success">å…¬å¼€</span>' : '<span class="badge badge-secondary">ç§æœ‰</span>'}
                    </div>
                    <div>
                        <span>${tags.length} ä¸ªæ ‡ç­¾</span>
                        <a href="/repository/${repo.name}" class="btn btn-sm">æŸ¥çœ‹è¯¦æƒ…</a>
                    </div>
                `;
                repoList.appendChild(repoItem);
            }
        }
        
        document.getElementById('push-repos').textContent = userInfo.is_admin ? 'æ‰€æœ‰' : '-';
        
        // Check registry status
        const statusEl = document.getElementById('registry-status');
        statusEl.innerHTML = '<span class="status-dot status-success"></span><span>è¿è¡Œæ­£å¸¸</span>';
        
    } catch (error) {
        console.error('Failed to load dashboard:', error);
        document.getElementById('recent-repos').innerHTML = '<p class="error">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
    }
}
</script>
{% endblock %}
