{% extends "base.html" %}

{% block title %}权限管理 - Docker Registry Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h1>权限管理</h1>
    <button onclick="showCreatePermissionModal()" class="btn btn-primary">添加权限</button>
</div>

<div class="card">
    <div class="card-body">
        <table class="data-table" id="permissions-table">
            <thead>
                <tr>
                    <th>用户</th>
                    <th>仓库</th>
                    <th>拉取</th>
                    <th>推送</th>
                    <th>删除</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6" class="loading">加载中...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Create Permission Modal -->
<div id="createPermissionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>添加权限</h2>
            <span class="close" onclick="closeCreatePermissionModal()">&times;</span>
        </div>
        <form onsubmit="createPermission(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label for="perm-user">用户 *</label>
                    <select id="perm-user" required>
                        <option value="">选择用户...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="perm-repo">仓库 *</label>
                    <select id="perm-repo" required>
                        <option value="">选择仓库...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="perm-pull" checked>
                        允许拉取 (Pull)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="perm-push">
                        允许推送 (Push)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="perm-delete">
                        允许删除 (Delete)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeCreatePermissionModal()" class="btn">取消</button>
                <button type="submit" class="btn btn-primary">创建</button>
            </div>
        </form>
    </div>
</div>

<script>
let allUsers = [];
let allRepos = [];

document.addEventListener('DOMContentLoaded', async () => {
    await loadPermissions();
    await loadUsersAndRepos();
});

async function loadPermissions() {
    try {
        const permissions = await apiRequest('/api/permissions/');
        const tbody = document.querySelector('#permissions-table tbody');
        
        if (permissions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">暂无权限记录</td></tr>';
            return;
        }
        
        // We need to enrich permissions with user and repo names
        const users = await apiRequest('/api/users/');
        const repos = await apiRequest('/api/repositories/');
        
        tbody.innerHTML = permissions.map(perm => {
            const user = users.find(u => u.id === perm.user_id);
            const repo = repos.find(r => r.id === perm.repository_id);
            
            return `
                <tr>
                    <td>${user ? user.username : 'Unknown'}</td>
                    <td>${repo ? repo.name : 'Unknown'}</td>
                    <td>${perm.can_pull ? '✓' : '✗'}</td>
                    <td>${perm.can_push ? '✓' : '✗'}</td>
                    <td>${perm.can_delete ? '✓' : '✗'}</td>
                    <td>
                        <button onclick="deletePermission(${perm.id})" class="btn btn-sm btn-danger">删除</button>
                    </td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Failed to load permissions:', error);
    }
}

async function loadUsersAndRepos() {
    try {
        allUsers = await apiRequest('/api/users/');
        allRepos = await apiRequest('/api/repositories/');
        
        const userSelect = document.getElementById('perm-user');
        const repoSelect = document.getElementById('perm-repo');
        
        userSelect.innerHTML = '<option value="">选择用户...</option>' +
            allUsers.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
        
        repoSelect.innerHTML = '<option value="">选择仓库...</option>' +
            allRepos.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    } catch (error) {
        console.error('Failed to load users and repos:', error);
    }
}

function showCreatePermissionModal() {
    document.getElementById('createPermissionModal').style.display = 'block';
}

function closeCreatePermissionModal() {
    document.getElementById('createPermissionModal').style.display = 'none';
}

async function createPermission(event) {
    event.preventDefault();
    
    const userId = parseInt(document.getElementById('perm-user').value);
    const repoId = parseInt(document.getElementById('perm-repo').value);
    const canPull = document.getElementById('perm-pull').checked;
    const canPush = document.getElementById('perm-push').checked;
    const canDelete = document.getElementById('perm-delete').checked;
    
    try {
        await apiRequest('/api/permissions/', {
            method: 'POST',
            body: JSON.stringify({
                user_id: userId,
                repository_id: repoId,
                can_pull: canPull,
                can_push: canPush,
                can_delete: canDelete
            })
        });
        
        closeCreatePermissionModal();
        await loadPermissions();
        alert('权限添加成功');
    } catch (error) {
        alert('添加权限失败: ' + error.message);
    }
}

async function deletePermission(permId) {
    if (!confirm('确定要删除此权限吗？')) {
        return;
    }
    
    try {
        await apiRequest(`/api/permissions/${permId}`, { method: 'DELETE' });
        await loadPermissions();
        alert('权限已删除');
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}
</script>
{% endblock %}
