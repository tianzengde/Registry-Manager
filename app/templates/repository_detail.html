{% extends "base.html" %}

{% block title %}{{ repo_name }} - Docker Registry Manager{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <a href="/repositories" class="back-link">â† è¿”å›ä»“åº“åˆ—è¡¨</a>
        <h1 id="repo-name">{{ repo_name }}</h1>
    </div>
</div>

<div class="repo-info card">
    <div class="card-body">
        <p><strong>ä»“åº“åç§°:</strong> <span id="repo-name-display">{{ repo_name }}</span></p>
        <p><strong>è®¿é—®ç±»å‹:</strong> <span id="repo-type">-</span></p>
        <p><strong>æ ‡ç­¾æ•°é‡:</strong> <span id="tag-count">-</span></p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>é•œåƒæ ‡ç­¾</h3>
    </div>
    <div class="card-body">
        <div id="tags-list" class="tags-list">
            <p class="loading">åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<!-- Image Detail Modal -->
<div id="imageModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modal-image-title">é•œåƒè¯¦æƒ…</h2>
            <span class="close" onclick="closeImageModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="image-details">
                <p class="loading">åŠ è½½ä¸­...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeImageModal()" class="btn">å…³é—­</button>
        </div>
    </div>
</div>

<script>
const repoName = "{{ repo_name }}";

document.addEventListener('DOMContentLoaded', async () => {
    await loadRepositoryDetails();
});

async function loadRepositoryDetails() {
    try {
        // Load repository info
        const repos = await apiRequest('/api/repositories/');
        const repo = repos.find(r => r.name === repoName);
        
        if (repo) {
            document.getElementById('repo-type').innerHTML = 
                repo.is_public ? '<span class="badge badge-success">å…¬å¼€</span>' : '<span class="badge badge-secondary">ç§æœ‰</span>';
        }
        
        // Load tags - URL encode the repository name to handle special characters like /
        const encodedRepo = encodeURIComponent(repoName).replace(/%2F/g, '/');
        const tagsData = await apiRequest(`/api/images/${encodedRepo}/tags`);
        const tags = tagsData.tags || [];
        
        document.getElementById('tag-count').textContent = tags.length;
        
        const tagsList = document.getElementById('tags-list');
        if (tags.length === 0) {
            tagsList.innerHTML = '<p>æ­¤ä»“åº“æš‚æ— é•œåƒæ ‡ç­¾</p>';
            return;
        }
        
        tagsList.innerHTML = tags.map(tag => `
            <div class="tag-item">
                <div class="tag-info">
                    <h4>${tag}</h4>
                    <button onclick="showPullCommand('${tag}')" class="btn btn-sm">ğŸ“‹ è·å–æ‹‰å–å‘½ä»¤</button>
                </div>
                <div class="tag-actions">
                    <button onclick="showImageDetails('${tag}')" class="btn btn-sm btn-primary">æŸ¥çœ‹è¯¦æƒ…</button>
                    <button onclick="deleteImageTag('${tag}')" class="btn btn-sm btn-danger admin-only">åˆ é™¤æ ‡ç­¾</button>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load repository details:', error);
        document.getElementById('tags-list').innerHTML = '<p class="error">åŠ è½½å¤±è´¥: ' + error.message + '</p>';
    }
}

async function showPullCommand(tag) {
    try {
        // URL encode the repository name to handle special characters like /
        const encodedRepo = encodeURIComponent(repoName).replace(/%2F/g, '/');
        const response = await apiRequest(`/api/images/${encodedRepo}/${tag}/pull-command`);
        
        // Copy to clipboard with fallback
        const command = response.command;
        let copied = false;
        
        // Try modern clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try {
                await navigator.clipboard.writeText(command);
                copied = true;
            } catch (e) {
                console.warn('Clipboard API failed, using fallback');
            }
        }
        
        // Fallback: Create a temporary textarea
        if (!copied) {
            const textarea = document.createElement('textarea');
            textarea.value = command;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                copied = true;
            } catch (e) {
                console.error('Fallback copy failed:', e);
            }
            document.body.removeChild(textarea);
        }
        
        // Show notification
        if (copied) {
            alert(`æ‹‰å–å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿:\n\n${command}`);
        } else {
            // If copy failed, show the command for manual copy
            const userInput = prompt('æ— æ³•è‡ªåŠ¨å¤åˆ¶ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å‘½ä»¤:', command);
        }
    } catch (error) {
        console.error('Failed to get pull command:', error);
        alert('è·å–æ‹‰å–å‘½ä»¤å¤±è´¥: ' + error.message);
    }
}

async function showImageDetails(tag) {
    document.getElementById('imageModal').style.display = 'block';
    document.getElementById('modal-image-title').textContent = `${repoName}:${tag}`;
    document.getElementById('image-details').innerHTML = '<p class="loading">åŠ è½½ä¸­...</p>';
    
    try {
        // URL encode the repository name to handle special characters like /
        const encodedRepo = encodeURIComponent(repoName).replace(/%2F/g, '/');
        const details = await apiRequest(`/api/images/${encodedRepo}/${tag}/details`);
        
        const sizeInMB = (details.size / 1024 / 1024).toFixed(2);
        const layers = details.layers || [];
        const env = details.env || [];
        const labels = details.labels || {};
        const history = details.history || [];
        
        document.getElementById('image-details').innerHTML = `
            <div style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 1rem;">åŸºæœ¬ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>æ ‡ç­¾:</strong>
                        <span>${details.repository}:${details.tag}</span>
                    </div>
                    <div class="detail-item">
                        <strong>é•œåƒæ‘˜è¦:</strong>
                        <span style="font-size: 0.85em; word-break: break-all;">${details.digest || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>æ”¯æŒæ¶æ„:</strong>
                        <span>${details.os || 'N/A'} / ${details.architecture || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>åˆ›å»ºæ—¥æœŸ:</strong>
                        <span>${details.created ? new Date(details.created).toLocaleString('zh-CN') : 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>å¤§å°:</strong>
                        <span>${sizeInMB} MB</span>
                    </div>
                    ${details.user ? `
                    <div class="detail-item">
                        <strong>ç”¨æˆ·:</strong>
                        <span>${details.user}</span>
                    </div>
                    ` : ''}
                    ${details.workdir ? `
                    <div class="detail-item">
                        <strong>å·¥ä½œç›®å½•:</strong>
                        <span>${details.workdir}</span>
                    </div>
                    ` : ''}
                </div>
            </div>

            ${Object.keys(labels).length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">å…ƒæ•°æ®æ ‡ç­¾ (${Object.keys(labels).length})</h3>
                    <div style="background: var(--bg-color); padding: 1rem; border-radius: 0.5rem;">
                        ${Object.entries(labels).map(([key, value]) => `
                            <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.25rem;">${key}</div>
                                <div style="word-break: break-all; font-size: 0.9em;">${value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${env.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">ç¯å¢ƒå˜é‡</h3>
                    <div class="detail-grid">
                        ${env.map(envVar => {
                            const [key, ...valueParts] = envVar.split('=');
                            const value = valueParts.join('=');
                            return `
                                <div class="detail-item">
                                    <strong>${key}:</strong>
                                    <span style="word-break: break-all;">${value || '(æœªè®¾ç½®)'}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}

            ${details.cmd || details.entrypoint ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">è¿è¡Œé…ç½®</h3>
                    <div class="detail-grid">
                        ${details.entrypoint ? `
                            <div class="detail-item">
                                <strong>å…¥å£ç‚¹ (Entrypoint):</strong>
                                <span><code>${Array.isArray(details.entrypoint) ? details.entrypoint.join(' ') : details.entrypoint}</code></span>
                            </div>
                        ` : ''}
                        ${details.cmd ? `
                            <div class="detail-item">
                                <strong>å‘½ä»¤ (CMD):</strong>
                                <span><code>${Array.isArray(details.cmd) ? details.cmd.join(' ') : details.cmd}</code></span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}

            ${details.exposed_ports && details.exposed_ports.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">æš´éœ²ç«¯å£</h3>
                    <p>${details.exposed_ports.join(', ')}</p>
                </div>
            ` : ''}

            ${details.volumes && details.volumes.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">æ•°æ®å·</h3>
                    <p>${details.volumes.join(', ')}</p>
                </div>
            ` : ''}

            ${layers.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">å±‚ä¿¡æ¯ (${layers.length} å±‚)</h3>
                    <div class="layers-list">
                        ${layers.map((layer, index) => `
                            <div class="layer-item">
                                <div>
                                    <strong>[#${String(index).padStart(3, '0')}]</strong>
                                    <span style="font-size: 0.85em; color: var(--text-secondary);">${layer.digest.substring(0, 20)}...</span>
                                </div>
                                <div>
                                    <span>${layer.percentage.toFixed(2)}%</span>
                                    <span>(${(layer.size / 1024 / 1024).toFixed(1)} MB)</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            ${history.length > 0 ? `
                <div style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">æ„å»ºè®°å½• (${history.length} æ­¥éª¤)</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${history.map((h, index) => `
                            <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-color); border-radius: 0.25rem; border-left: 3px solid var(--primary-color);">
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 0.25rem;">
                                    ${h.created ? new Date(h.created).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´'}
                                </div>
                                <code style="font-size: 0.9em; display: block; word-break: break-all;">
                                    ${h.created_by || '(æ— å‘½ä»¤)'}
                                </code>
                                ${h.comment ? `<div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 0.25rem;">${h.comment}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `;
    } catch (error) {
        console.error('Failed to load image details:', error);
        document.getElementById('image-details').innerHTML = '<p class="error">åŠ è½½è¯¦æƒ…å¤±è´¥: ' + error.message + '</p>';
    }
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

async function deleteImageTag(tag) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤é•œåƒæ ‡ç­¾ "${repoName}:${tag}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        return;
    }
    
    try {
        // URL encode the repository name to handle special characters like /
        const encodedRepo = encodeURIComponent(repoName).replace(/%2F/g, '/');
        await apiRequest(`/api/images/${encodedRepo}/${tag}`, { method: 'DELETE' });
        
        // é‡æ–°åŠ è½½é¡µé¢æ•°æ®
        await loadRepositoryDetails();
        alert('é•œåƒæ ‡ç­¾åˆ é™¤æˆåŠŸ');
    } catch (error) {
        console.error('Failed to delete image tag:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}
</script>
{% endblock %}
